<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ai.gzesp.dao.MyAcctDao">

	<select id="queryAcctByUserId" resultType="java.util.HashMap">
	select a.USER_ID,
	       ACCT_ID,
	       trunc(BALANCE/1000,2) as BALANCE,
	       ACCT_TYPE,
	       ACCT_STATUS,
	       b.PASSWORD,
	       UPDATE_TIME
	  from ACT_D_ACCOUNT a, ACT_D_PAY_PASSWORD b 
	 where a.ACCT_TYPE = '2' 
	   and a.user_id = b.user_id(+)
	   and a.user_id = #{user_id}
	</select>	
	<select id="queryAcctBankByUserId" resultType="java.util.HashMap">
	select a.*, b.param_value
	  from ACT_D_BANKCARD a, SYS_D_ESPPARAM b
	 where b.param_type = 'BANK_TYPE'
	   and b.param_code = a.bank_type
	   and a.valid_flag='1'
	   and a.user_id = #{user_id}
	</select>
	<insert id="insertAcctPwd">
		insert into ACT_D_PAY_PASSWORD
			(user_id,password,update_time)
		values(#{user_id},#{user_pwd},sysdate)
	</insert>
	<update id="updateAcctPwd">
		update ACT_D_PAY_PASSWORD set password=#{user_pwd},update_time=sysdate where user_id=#{user_id}
	</update>
	
	<select id="queryAcctByUserId_UserPwd" resultType="java.util.HashMap">
	select *
	  from ACT_D_PAY_PASSWORD
	 where user_id = #{user_id}
	   and password = #{user_pwd}
	</select>
	<insert id="insertAcctBank">
		insert into ACT_D_BANKCARD
		  (user_id, bank_no,cvn2,phone,name,certificate_code,expire_date,card_type,bank_type,sign_code,priority,valid_flag,sys_trade_no)
		values
		  (
		   #{user_id},
		   #{bank_no},
		   #{cvn2},
		   #{phone},
		   #{name},
		   #{certificate_code},
		   #{expire_date},
		   #{card_type},
		   #{bank_type},
		   #{sign_code},
		   #{priority},
		   #{valid_flag},
		   #{sys_trade_no})
	</insert>
	<update id="updateAcctBank">
		update ACT_D_BANKCARD set 
		user_id=#{valid_flag},
		bank_no=#{bank_no},
		cvn2=#{cvn2},
		phone=#{phone},
		name=#{name},
		certificate_code=#{certificate_code},
		expire_date=#{expire_date},
		card_type=#{card_type},
		bank_type=#{bank_type},
		sign_code=#{sign_code},
		priority=#{priority},
		valid_flag=#{valid_flag},
		sys_trade_no==#{sys_trade_no}
		where user_id=#{user_id} and bank_no=#{bank_no}
	</update>
	
	<select id="queryAcctBankDetail" resultType="java.util.HashMap">
		select a.*, b.param_value
		  from ACT_D_BANKCARD a, SYS_D_ESPPARAM b
		 where b.param_type = 'BANK_TYPE'
		   and b.param_code = a.bank_type
		   and a.user_id = #{user_id}
		   and a.bank_no = #{bank_no}
	</select>
	
	<select id="queryAcctBalanceLog" resultType="java.util.HashMap">
		with T1 as
		 (select a.User_Id, b.*
		    from ACT_D_ACCOUNT a, ACT_D_ACCESS_LOG b
		   where a.acct_id = b.acct_id
		     and a.acct_status = '1'
		     and a.acct_type = '2'
		       and a.user_id=#{user_id}
		       <if test="iFlag == 0">
		       	and  TRADE_TYPE in('10','51')
		       </if>
		       <if test="iFlag == 1">
		       	and  TRADE_TYPE in('22','52')
		       </if>
		       <if test="iFlag == 2">
		       	and  TRADE_TYPE = '60'
		       </if>
	           <if test="update_time != ''">
	               <![CDATA[ 
	                 and b.update_time>=trunc(to_date(#{update_time},'yyyy-mm'), 'MM')
	                 and b.update_time<trunc(add_months(to_date(#{update_time},'yyyy-mm'),1),'MM')
	                  ]]>
	           </if>
		   order by b.update_time desc),
		T2 as
		 (select a.*
		    from ACT_D_WITHDRAW_AUDIT a
		   where a.user_id = #{user_id})
		select T1.user_id,
	       T1.order_id,
	       case when T1.trade_type ='10' then
	             '佣金转入'
	            when T1.trade_type ='51' then
	              '佣金回退'
	            when T1.trade_type ='22' then
	              '代客下单'
	            when T1.trade_type ='52' then
	              '支付回退'
	            when T1.trade_type ='60' then
	              '提现'
	            else
	              '未知'                           
	       end trade_type,
	       trunc(T1.old_balance/1000,2) as old_balance,  
 	       trunc(T1.new_balance/1000,2) as new_balance,
	       trunc(T1.fee/1000,2) as fee,
	       T1.update_time,
	       trunc(T2.withdraw_fee/1000,2) as withdraw,
	       case when T2.audit_state ='01' then
	         '审核中'
	         else
	           '未知'
	       end audit_state,
	       T2.apply_time
	  from T1, T2
	 where T1.user_id = T2.user_id(+)
	 order by T1.update_time desc

	</select>
	
	<select id="queryAcctBalanceLogPage" resultType="java.util.HashMap">
		with T1 as
		 (select a.User_Id, b.*
		    from ACT_D_ACCOUNT a, ACT_D_ACCESS_LOG b
		   where a.acct_id = b.acct_id
		     and a.acct_status = '1'
		     and a.acct_type = '2'
		       and a.user_id=#{user_id}
		       <if test="iFlag == 0">
		       	and  TRADE_TYPE in ('10','51')
		       </if>
		       <if test="iFlag == 1">
		       	and  TRADE_TYPE in('22','52')
		       </if>
		       <if test="iFlag == 2">
		       	and  TRADE_TYPE = '60'
		       </if>
	           <if test="update_time != ''">
	               <![CDATA[ 
	                 and b.update_time>=trunc(to_date(#{update_time},'yyyy-mm'), 'MM')
	                 and b.update_time<trunc(add_months(to_date(#{update_time},'yyyy-mm'),1),'MM')
	                  ]]>
	           </if>
		   order by b.update_time desc),
		T2 as
		 (select a.*
		    from ACT_D_WITHDRAW_AUDIT a
		   where a.user_id = #{user_id})
		select *
		  from (select tt.*, ROWNUM as rowno
		          from (select T1.user_id,
		                       T1.order_id,
		                       case when T1.trade_type ='10' then
		                             '佣金转入'
		                            when T1.trade_type ='51' then
		                              '佣金回退'
		                            when T1.trade_type ='22' then
		                              '代客下单'
		                            when T1.trade_type ='52' then
		                              '支付回退'
		                            when T1.trade_type ='60' then
		                              '提现'
		                            else
		                              '未知'                           
		                       end trade_type,
						       trunc(T1.old_balance/1000,2) as old_balance,  
					 	       trunc(T1.new_balance/1000,2) as new_balance,
						       trunc(T1.fee/1000,2) as fee,
						       T1.update_time,
						       trunc(T2.withdraw_fee/1000,2) as withdraw,
		                       case when T2.audit_state ='01' then
		                         '审核中'
		                         else
		                           '未知'
		                       end audit_state,
		                       T2.apply_time
		                  from T1, T2
		                 where T1.user_id = T2.user_id(+)
		                 order by T1.update_time desc
		                 ) tt

		  <![CDATA[  
			  where Rownum <= (${page_num}*${page_size})) table_alias
			  where table_alias.rowno >= (${page_num}-1)*${page_size}+1
		 	]]>

	</select>
	
	<insert id="insertAccount">
		insert into ACT_D_ACCOUNT
		  (user_id, acct_id, balance, acct_type, acct_status, version)
		values
		  (#{user_id},
		   #{acct_id},
		   ${balance},
		   #{acct_type},
		   #{acct_status},
		   #{version})
	</insert>
	<select id="queryToPayMoneyByOrderId" resultType="java.util.HashMap">
		select to_char(totopay_money) as topay_money from ord_d_base where order_id=#{order_id}
	</select>

	
	
</mapper>